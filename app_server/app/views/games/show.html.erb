<p style="font-size: 20px;">
  <b>Name: <%=h @game.name %></b>
</p>

<script type="text/javascript" charset="utf-8">
  $(function(){
    
    var client = new Faye.Client('http://localhost:4567/faye');
    var subscription = client.subscribe('/game/<%= @game.id %>', function(message) {
      user = message.response.user.user;
      if (message.response.command == "delete"){
        
        $("#in_game li#user_"+user.id).remove();
        $("#not_in_game").append("<li id='user_"+user.id+"'>"+user.name+" <a href='#' class='add_seat' user_id='"+user.id+"'>+</a></li>");
        updateSeatCount(parseInt($("#seat_count").html())-1);
        onAddSeatClick($("#not_in_game li#user_"+user.id+" a"));
      } else{
        $("#not_in_game li#user_"+user.id).remove();
        $("#in_game").append("<li id='user_"+user.id+"'>"+user.name+" <a href='#' class='remove_seat' seat_id='"+message.response.id+"'>x</a></li>");
        updateSeatCount(parseInt($("#seat_count").html())+1);
        onDeleteSeatClick($("#in_game li#user_"+user.id+" a"));
      }
    });

    $.each($(".add_seat"), function(){
      onAddSeatClick($(this));
    });
    
    $.each($(".delete_seat"), function(){
      onDeleteSeatClick($(this));
    });
  });
  
  function onAddSeatClick(elem){
    elem.click(function(){
      $.get("http://localhost:4567/publish?command=post&api_path=/seats/%3Fseat[game_id]=<%= @game.id %>%26seat[user_id]="+elem.attr('user_id')+"&channel=/game/<%= @game.id %>");
    });
  }
  
  function onDeleteSeatClick(elem){
    elem.click(function(){
      $.get("http://localhost:4567/publish?command=delete&api_path=/seats/"+elem.attr('seat_id')+"&channel=/game/<%= @game.id %>");
    });
  }
  
  function updateSeatCount(val){
    $("#seat_count").html(val);
    $("#seat_count").pulse({
        opacity: [0,1]
    }, 200, 2);
  }
</script>
Users in Game:
<ul id="in_game">
  <% @game.seats.each do |seat| %>
    <li id="user_<%= seat.user.id %>"><%= seat.user.name %> <a href="#" class="delete_seat" seat_id="<%= seat.id %>">x</a></li>
  <% end %>
</ul>

Users NOT in Game:
<ul id="not_in_game">
  <% (User.all - @game.seats.map{|seat| seat.user}).each do |user| %>
    <li id="user_<%= user.id %>"><%= user.name %> <a href="#" class="add_seat" user_id="<%= user.id %>">+</a></li>
  <% end %>
</ul>

Seats in this game: <span id="seat_count" style="font-size: 20px;"><%= @game.seats.count %></span>
<br /><br /><br />
<%= link_to 'Edit', edit_game_path(@game) %> |
<%= link_to 'Back', games_path %>